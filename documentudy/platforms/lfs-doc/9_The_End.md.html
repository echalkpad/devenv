<hr>

<h2>목차  </h2>

<p><a href="#91-the-end">9.1. The End  </a> <br>
<a href="#92-get-counted">9.2. Get Counted  </a> <br>
<a href="#93-rebooting-the-system">9.3. Rebooting the System  </a> <br>
<a href="#94-what-now?">9.4. What Now? </a> <br>
<a href="#95-추가-설정">9.5. 추가 설정.</a> <br>
<a href="#96-내가만든-LFS를-USB로-부팅가능하게-만들기">9.6. 내가만든 LFS를 USB로 부팅하게 만들기.</a> <br>
<a href="#97-LFS파일시스템-Ramdisk로-압축하여-부팅USB만들기.">9.7. LFS 파일시스템 Ramdisk로 압축하여 부팅USB만들기.</a>  </p>

<hr>

<h1>9.1. The End</h1>

<p>이제 새로운 custom LFS시스템이 완전히 설치되었다.   </p>

<ul>
<li><strong>release 노트 파일생성</strong>    </li>
</ul>

<p><code>sh <br>
echo 7.7 &gt; /etc/lfs-release
</code>  </p>

<ul>
<li><strong>시스템 상태 보여주는 파일 생성</strong>    </li>
</ul>

<p><code>sh <br>
cat &gt; /etc/lsb-release &lt;&lt; "EOF" <br>
DISTRIB_ID="Linux From Scratch" <br>
DISTRIB_RELEASE="7.7" <br>
DISTRIB_CODENAME="&lt;your name here&gt;" <br>
DISTRIB_DESCRIPTION="Linux From Scratch" <br>
EOF
</code>  </p>

<h2>--------------------      </h2>

<h1>9.2. Get Counted</h1>

<p>Register하기. <br>
http://www.linuxfromscratch.org/cgi-bin/lfscounter.php   </p>

<p>```````````````````` <br>
Records 101 – 200 of 177  </p>

<p>LFS ID  Name            First LFS Version <br>
25608   Roberto Rodriguez Jr    7.7 <br>
25609   Moli            7.7 <br>
25610   Gerhard         7.7 <br>
25611   Ji-Hun Kim      7.7 <br>
````````````````````  </p>

<p>Let`s reboot into LFS now.  </p>

<h2>--------------------      </h2>

<h1>9.3. Rebooting the System</h1>

<p>shutdown -r now  </p>

<h2>--------------------      </h2>

<h1>9.4. What Now?</h1>

<p>BLFS or piLFS?  </p>

<h2>--------------------      </h2>

<h1>9.5. 추가 설정.</h1>

<hr>

<h2>bash 쉘 프롬프트 모양 바꾸기</h2>

<p>현재 <code>-bash-4.3.3 $</code> 이렇게 되어있음. <br>
echo $PS1 해보면 <code>PS1="-\s-\v$ "</code> 이렇게 나와서 그렇다 <br>
PS1 환경변수를 수정해야한다. <br>
참고  http://webdir.tistory.com/105   </p>

<p>현재 LFS시스템에는 root계정밖에 없으니 root의 홈 디렉토리인 /root/밑에 <br>
.bashrc 파일을 만들어 아래와같이 환경변수 셋팅을 해주면됨. <br>
참고 http://superuser.com/questions/268460/wheres-bashrc-for-root  </p>

<ul>
<li><strong>/root/.bashrc파일에 아래와같이 입력</strong>  </li>
</ul>

<p><code>sh
export PS1="\u@\h:\w\$ "
</code></p>

<blockquote>
  <p>\u : user계정명 <br>
\h : host name <br>
\w : full path <br>
\$ : $모양 표시 (\$ : root일때 #으로 바꿔줌)  </p>
</blockquote>

<ul>
<li><strong>그 뒤 bashrc 적용</strong>  </li>
</ul>

<p><code>sh
 $ source /root/.bashrc
</code></p>

<blockquote>
  <p>여기에하면 재부팅할때마다 적용해줘야함. <br>
/etc/profile 에 써주면  재부팅시 바로 적용됨.  </p>
</blockquote>

<h2>--------------------      </h2>

<h1>9.6 내가만든 LFS를 USB로 부팅가능하게 만들기.</h1>

<h3>9.6.1. 배경 및 사전조사</h3>

<p>lfs현재 상태를 mkisofs  를 이용해 .iso 파일로 만들고 <br>
USB에 grub을 설치하고 MBR? 로 설정하여 부팅가능하게 하면 되려나? <br>
일단 아무 폴더를 iso로 만들고 mount하니까 파일 그대로 볼수 있었음.  </p>

<ul>
<li><strong>iso생성 및 mount테스트</strong>  </li>
</ul>

<p><code>sh
 $ mkisofs -r -V "test ISO" -o iso_test_vimdic.iso ~/Downloads/vimdic-master
 $ sudo mount -o loop ~/Downloads/iso_test_vimdic.iso /mnt/test_iso/
</code></p>

<p>http://www.linuxquestions.org/questions/linux-from-scratch-13/booting-lfs-from-usb-stick-897465/ <br>
일반적인방법 <br>
http://www.pendrivelinux.com/boot-multiple-iso-from-usb-via-grub2-using-linux/ <br>
http://www.pendrivelinux.com/install-grub2-on-usb-from-ubuntu-linux/  </p>

<p>ISO 이미지 만들기. <br>
http://idchowto.com/index.php/linux%EC%97%90%EC%84%9C-iso-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A7%8C%EB%93%A4%EA%B8%B0-mkisofs/</p>

<p>참고 블로그 <br>
http://blog.daum.net/bagjunggyu/118
http://bagjunggyu.blogspot.kr/2014/04/ubuntu-1404-lts-usb.html</p>

<h3>9.6.2. USB에 GRUB 설치 테스트</h3>

<p>http://www.pendrivelinux.com/boot-multiple-iso-from-usb-via-grub2-using-linux/
따라서 USB에 Grub설치하기.</p>

<p><code>(참고)</code> dd 와 mkisofs로 ISO 파일 만들기.  </p>

<blockquote>
  <ul>
<li><strong>mkisofs 이용</strong>   </li>
</ul>

<p><code>sh
 $ mount -v -t ext4 /dev/sdb5 /mnt/lfs
 $ mkisofs -r -V "test ISO" -o lfs-7-7.iso /mnt/lfs
</code>
나중에 iso를 mount 할때는 mount -t ext4 옵션으로 mount가 안되고 -o loop로
mount 해야함. <br>
lfs iso이미지는 이렇게 만듦.  </p>

<ul>
<li><strong>dd 이용</strong>   </li>
</ul>

<p><code>sh
 $ dd if=/dev/sdb5 of=lfs-7-7.iso
</code></p>

<ul>
<li><strong>일반적인 iso 관련 사용법?</strong>   </li>
</ul>

<p><code>
files -&gt; iso      $ mkisofs -o image.iso &lt;pathlist&gt;
view iso      $ mount image.iso -o loop &lt;dirname&gt;
iso -&gt; CD     $ cdrecord -v -eject dev=&lt;i,j,k&gt; image.iso
CD -&gt; iso     $ dd if=/dev/cdrom of=image.iso
</code></p>
</blockquote>

<h3>9.6.3. 파일시스템 통째로 복사하여 USB 부팅 하기</h3>

<p>아래대로 따라해서 usb에 grub으로 부팅 성공함. 
//iso를 로딩하는 grub설정 방법은 추후 확인.  </p>

<h4>(1). Format your USB Flash Drive to use a Single Partition:</h4>

<p>````````````````````sh</p>

<p>Open a terminal and type sudo su
 $ fdisk -l (and note which device is your USB Drive)
 $ fdisk /dev/sdx (replacing x with your actual usb device)
    Type d (to delete the existing partition)
    Type n (to create a new partition)
    Type p (for primary partition)
    Type 1 (to create the first partition)
    Press Enter (to use the first cylinder)
    Press Enter again (to use the default value as the last cylinder)
    Type a (for active)
    Type 1 (to mark the first partition active "bootable")
    Type t (for partition type)
    Type 83 (to use linux partition)
    Type w (to write the changes and close fdisk)
````````````````````</p>

<blockquote>
  <p><code>(주의)</code>  fdisk /dev/sdx  sdx1 이 아니라 sdx 임.  </p>
</blockquote>

<h4>(2). Create a ext4 filesystem on the USB flash drive:</h4>

<p><code>sh
sudo umount /dev/sdc1 (or whatever your usb is)
sudo mkfs.ext4 /dev/sdc1
</code></p>

<h4>(3). Install Grub2 on the USB Flash Drive:</h4>

<p>````````````````````sh
mkdir /mnt/USB &amp;&amp; mount /dev/sdx1 /mnt/USB (replacing x with your actual usb device)</p>

<p>grub-install --force --no-floppy --boot-directory=/mnt/USB/boot /dev/sdx
(replacing x with your actual USB device)</p>

<p>cd /mnt/USB/boot/grub (to change directory)
wget pendrivelinux.com/downloads/grub.cfg</p>

<p>````````````````````</p>

<blockquote>
  <p><code>(주의)</code> grub-install 설치 옵션에  /dev/sdx 임을 주의
이렇게하면 USB로 재부팅시 grub화면이 보임.  </p>
</blockquote>

<h4>(4). LFS 루트파일시스템 USB로 통째로 복사</h4>

<p><code>sh <br>
 $ mount /dev/sdc1 /mnt/USB
 $ mount /dev/sdb5 /mnt/lfs
 $ cd /mnt/lfs
 $ cp -avp bin/ dev/ etc/ home/ lib/ lib64 media/ mnt/ opt/ proc/ root/ run/ sbin/ sources/ srv/ sys/ tmp/ usr/ var/ /mnt/USB/
 $ cp boot/* /mnt/USB/boot/
</code></p>

<blockquote>
  <p>iso로딩 대신 이방법 사용.  </p>
</blockquote>

<h4>(5). grub.cfg 수정.</h4>

<p>````````````````````sh <br>
cat > boot/grub/grub.cfg &lt;&lt; "EOF"</p>

<h1>Begin /boot/grub/grub.cfg</h1>

<p>set default=0
set timeout=5</p>

<p>insmod ext2
set root=(hd0,1)</p>

<p>menuentry "GNU/Linux, Linux 3.19-lfs-7.7" {
            linux   /boot/vmlinuz-3.19-lfs-7.7 root=/dev/sdc1 ro
}
EOF
````````````````````</p>

<blockquote>
  <p>(hd0,1) USB의 첫번째 파티션이므로 1임. <br>
root=/dev/sdc1 으로 수정  </p>

<p>http://linuxfromscratch.org/lfs/view/stable/chapter08/grub.html  </p>

<p>여기까지하면 가까스로 부팅은 됨.
하지만 중간에 부팅이 멈춤.  </p>
</blockquote>

<h4>(6). initrd 추가.</h4>

<ul>
<li>initrd 이미지 HOST의 것으로 복사</li>
</ul>

<p><code>sh <br>
cp  /boot/initrd.img-3.8.0-42-generic  /mnt/USB/boot/
</code>  </p>

<blockquote>
  <p>실제로는 커널을 빌드할때 config 옵션으로 initrd를 줘서 생성한 initrd를 추가해줘야할듯  </p>
</blockquote>

<ul>
<li>grub.cfg 에 initrd추가  </li>
</ul>

<p><code>patch <br>
menuentry "GNU/Linux, Linux 3.19-lfs-7.7" {
        linux   /boot/vmlinuz-3.19-lfs-7.7 root=/dev/sdc1 ro
+       initrd  /boot/initrd.img-3.8.0-42-generic
}
</code>  </p>

<p>여기까지하면 HOST PC에서 USB로 부팅이 됨. 하지만 다른 PC에서 부팅안됨. 이유는
다른 PC에서는 USB가 grub에 지정한 /dev/sdc1으로 마운트 되지 않을 수도 있기때문이다. <br>
따라서 /dev/sdx의 절대경로를 지정하는게 아니라 UUID로 지정하면 이 문제를 해결할 수 있음.</p>

<p><code>(찾아보기)</code> initrd란?</p>

<blockquote>
  <p>initrd란 램디스크를 의미한다. <br>
 압축을 풀고 확인하면, 작은 파일시스템이 들어있다. <br>
필요한 이유 <br>
다음과 같은 상황에 필요 <br>
1. SCSI 하드디스크 장치만 가지고 있다. <br>
2. 커널 이미지에는 SCSI 기능이 들어 있지 않다. <br>
3. SCSI 기능은 모듈로 처리되어 있다. <br>
커널이 부팅하면서 SCSI 하드 디스크를 읽어야 하는데, 커널에는 SCSI 기능이
들어있지 않다. <br>
SCSI 기능이 없으므로(아직 올라오지 않음) SCSI 하드디스크를 읽을 수가 없다. <br>
 그래서 패닉이 생긴다. <br>
http://egloos.zum.com/gimgimal/v/1246071 <br>
http://icecreamie.tistory.com/m/post/13  </p>
</blockquote>

<h4>(7) USB의 UUID 설정하기.</h4>

<p>모든 PC에서 부팅 가능해짐.</p>

<p>root=UUID= (16진수 주소) <br>
blkid 로 UUID확인  </p>

<ul>
<li>grub.cfg 수정.</li>
</ul>

<p><code>patch <br>
menuentry "GNU/Linux, Linux 3.19-lfs-7.7" {
-           linux   /boot/vmlinuz-3.19-lfs-7.7 root=/dev/sdc1 ro
+           linux   /boot/vmlinuz-3.19-lfs-7.7 root=UUID=c8124732-5693-4f0e-8dec-cff6508173df ro
        initrd  /boot/initrd.img-3.8.0-42-generic
}
</code>  </p>

<ul>
<li>/etc/fstab 의 root파일 시스템의 mount point를 USB의 UUID로 수정   </li>
</ul>

<p><code>patch <br>
- /dev/sdb5      /            ext4     defaults            1     1
+ UUID=c8124732-5693-4f0e-8dec-cff6508173df      /  ext4     defaults 1     1
</code>  </p>

<blockquote>
  <p>fstab은 부팅시 디폴트로 마운트할 파일시스템을 기술하는 파일이다. <br>
루트(/)파일 시스템은 USB자체를 마운트 하여 사용하므로 USB의 경로로 지정해줘야함. <br>
/dev/sdx 로해도되지만 UUID로 변경  </p>
</blockquote>

<hr>

<h3>9.6.4. 추가 확인해볼 사항들.</h3>

<p><code>(찾아보기)</code> grub.cfg 설정방법 찾아보기
http://www.normalesup.org/~george/comp/live<em>iso</em>usb/</p>

<p><code>(참고)</code> .img 파일 마운트하기.  </p>

<blockquote>
  <p>라즈비안 img를 받아서 마운트 해보기. <br>
https://www.raspberrypi.org/downloads/ <br>
참고 : http://www.meadhbh.org/mountraspianimages  </p>

<ul>
<li><p><strong>fdisk로 block 확인?</strong>    </p>

<h1>fdisk -l 2015-05-05-raspbian-wheezy.img</h1></li>
</ul>

<p>```````````````````` <br>
Disk 2015-05-05-raspbian-wheezy.img: 3276 MB, 3276800000 bytes <br>
255 heads, 63 sectors/track, 398 cylinders, total 6400000 sectors <br>
Units = sectors of 1 * 512 = 512 bytes <br>
Sector size (logical/physical): 512 bytes / 512 bytes <br>
I/O size (minimum/optimal): 512 bytes / 512 bytes <br>
Disk identifier: 0xa6202af7  </p>

<p>Device Boot      Start         End      Blocks   Id  System <br>
2015-05-05-raspbian-wheezy.img1            8192      122879       57344    c
W95 FAT32 (LBA) <br>
2015-05-05-raspbian-wheezy.img2          122880     6399999     3138560   83
Linux <br>
````````````````````  </p>

<ul>
<li><strong>loop로 마운트</strong>  </li>
</ul>

<p><code>
 # mount 2015-05-05-raspbian-wheezy.img -o loop,offset=$((512 * 122880))
 /mnt/rasp/
 # mount 2015-05-05-raspbian-wheezy.img -o loop,offset=$((512 * 8192))
 /mnt/rasp0/
</code> <br>
아래것이 /boot/에 있어야할 바이너리인듯.?  </p>
</blockquote>

<p><code>(참고)</code> raspbian sd card에 설치하기.  </p>

<p><code>sh
 $ fdisk 및 mkfs.ext4 이용 sd card포맷.
 $ dd bs=4M if=2015-05-05-raspbian-wheezy.img of=/dev/sdx
</code>
https://www.raspberrypi.org/documentation/installation/installing-images/linux.md  </p>

<p><code>(찾아보기)</code>  /dev/sdc /dev/sdc1 의 차이는? <br>
https://www.google.co.kr/search?client=ubuntu&amp;channel=fs&amp;q=difrence+%2Fdev%2Fsdb+%2Fdev%2Fsdb1&amp;ie=utf-8&amp;oe=utf-8&amp;gfe_rd=cr&amp;ei=crDnVeGNJ-bC8AenvaCwBA  </p>

<p><code>(찾아보기)</code>  spindle 라즈베리파이에서사용한 부팅시스템? <br>
http://asbradbury.org/projects/spindle/  </p>

<p><code>(참고)</code> pc 부팅 과정 <br>
1. BIOS를 통해 부트로더 로딩 <br>
2. GRUBbootloader를 통해 커널과 initrd를 램에 적재 <br>
3. 커널 로딩후 initrd를 통해 root fileSystem을  읽기로  마운트 <br>
4. init.rc/mountfs 스크립트를 통해 root fileSystem 읽기쓰기로 다시 마운트 (fstab 파일로딩 따라서 여기에 마운트 포지션도 변경이 필요) <br>
5. 초기화 과정 진행  </p>

<p><code>(찾아보기)</code> pc와 임베디드보드 bootloader차이  </p>

<p><code>(참고)</code> 부팅관련 참고 사이트 <br>
libe CD 만들기. https://www.linux.co.kr/home/lecture/?leccode=113 <br>
램디스크의 구현과 응용프로그램 실행 <br>
http://webcache.googleusercontent.com/search?q=cache:7T2WBL5-1QgJ:cfile3.uf.tistory.com/attach/11250D3B4EC36C442FDFED+&amp;cd=8&amp;hl=ko&amp;ct=clnk&amp;gl=kr  </p>

<p><code>(참고)</code> initrd for LFS <br>
http://www.linuxfromscratch.org/hints/downloads/files/OLD/initrd.txt  </p>

<h2>--------------------</h2>

<h1>9.7 LFS 파일시스템 Ramdisk로 압축하여 부팅USB만들기.</h1>

<h3>9.7.1 파일 시스템 램디스크로 압축하기</h3>

<p><code>`sh
$dd if=/dev/zero of=ramdisk bs=1k count=1048576
$mkfs.ext4 ramdisk 
$mkdir /mnt/mnt_ramdisk
$mount ramdisk /mnt/mnt_ramdisk
$cp -avp /bin /etc /lib /mnt /proc /run /srv /tmp /var /dev /home /lib64 /media /opt /root /sbin /sys /usr /mnt/mnt_ramdisk <br>
$umount ramdisk
$gzip ramdisk
</code>
<code>(참고)</code> <br>
복사하는 내용은 lfs 파일시스템 폴더. <br>
fstab 수정 필요 /dev/ram0 이 루트파일시스템 위치 <br>
/dev 에 시스템 ram0을 복사해와야함 <br>
<code>(찾아보기)</code> dd명령어 <br>
https://wiki.kldp.org/HOWTO/html/Adv-Bash-Scr-HOWTO/zeros.html</p>

<h3>9.7.2 kernel 수정</h3>

<ul>
<li>커널 .config 수정 (1GB 램디스크를 지원하기 위해서)</li>
</ul>

<p><code>sh
CONFIG_BLK_DEV_RAM=y
CONFIG_BLK_DEV_RAM_COUNT=16
CONFIG_BLK_DEV_RAM_SIZE=1048576
</code></p>

<p><code>(참고)</code>menuconfig 이용 방법 <br>
<code>sh
$# make menuconfig
Device Drivers ---&gt;
 'Block devices-&gt;' 선택
&lt;*&gt; RAM block device support 에서 space bar x 2
(16) Default number of RAM disks (NEW)
(1048576) Default RAM disk size (kbytes) (NEW)
</code>  </p>

<ul>
<li>커널 빌드</li>
</ul>

<p><code>sh <br>
 $ make mrproper
 $ make menuconfig // 위 참고
 $ make
 $ cp -v arch/x86/boot/bzImage /mnt/USB/boot/vmlinuz-3.19-lfs-7.7
 $ cp -v System.map /boot/System.map-3.19
</code>  </p>

<h3>9.7.3 grub.cfg 수정 및 부팅</h3>

<p>커널 이미지와 압축된 램디스크를 grub에 맞게 설정해줌 <br>
<code>sh
/boot/vmlinuz-3.19-lfs-7.7 root=/dev/ram0 ro quiet splash <br>
initrd /boot/ramdisk.gz
</code>  </p>

<h3>9.7.4 fstab수정</h3>

<p><code>patch <br>
- /dev/sdb5      /            ext4     defaults            1     1
+ /dev/ram0      /            ext4     defaults            1     1
</code>  </p>

<p>이후 부팅완료 <br>
<code>$ free -h</code> 로 memory확인  </p>

<p><code>(참조사이트)</code> <br>
https://wiki.kldp.org/HOWTO/html/Bootdisk-HOWTO/buildroot.html (루트파일시스템제작) <br>
http://hulryung.tistory.com/204 (루트파일시스템) <br>
https://cms.kut.ac.kr/user/joo/IFC412/IFC412<em>09.pdf (ramdisk F/S 및 컴파일) <br>
http://egloos.zum.com/furmuwon/v/11145268 (initrd initramfs 차이점) <br>
http://www.iamroot.org/xe/QnA/60940 (initramfs) <br>
https://wiki.gentoo.org/wiki/GRUB2</em>Quick_Start/ko (grub2관련)</p>
